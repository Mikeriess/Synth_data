<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dataset Statistics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            background-color: #2C001E;
            color: #E95420;
        }
        .header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header a {
            color: #E95420;
            text-decoration: none;
            padding: 8px 15px;
            border: 1px solid #772953;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .header a:hover {
            background-color: #772953;
            color: white;
        }
        .dataset-info {
            margin-bottom: 25px;
            font-size: 18px;
            color: #E95420;
            padding-bottom: 10px;
            border-bottom: 1px solid #772953;
        }
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }
        .stats-card {
            background-color: #410D38;
            border: 1px solid #772953;
            border-radius: 5px;
            padding: 20px;
            color: #FFF;
        }
        .chart-section {
            margin-bottom: 60px;
        }
        .chart-title {
            margin-top: 0;
            margin-bottom: 20px;
            color: #E95420;
            border-bottom: 1px solid #772953;
            padding-bottom: 10px;
        }
        .chart-container {
            position: relative;
            height: 450px;
            width: 100%;
        }
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(44, 0, 30, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            color: #E95420;
            font-size: 18px;
            border-radius: 5px;
        }
        .spinner {
            border: 4px solid #772953;
            border-top: 4px solid #E95420;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #772953;
        }
        th {
            color: #E95420;
        }
        .chart-description {
            color: #CCC;
            font-size: 14px;
            margin-top: 10px;
            margin-bottom: 20px;
        }
        .prompt-container {
            position: relative;
            background-color: #410D38;
            border: 1px solid #772953;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 40px;
        }
        .prompt-text {
            font-family: monospace;
            white-space: pre-wrap;
            color: #FFF;
            line-height: 1.5;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background-color: #2C001E;
            border-radius: 3px;
        }
        .stats-description {
            color: #CCC;
            font-size: 14px;
            margin-top: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Dataset Statistics</h1>
        <div>
            <a href="index.html">Back to Inspector</a>
            <a href="view_annotations.html">View Annotations</a>
            <a href="/switch_dataset" class="action-button">Switch Dataset</a>
        </div>
    </div>

    <div id="dataset-info" class="dataset-info">Loading dataset information...</div>

    <div class="chart-section">
        <h2 class="chart-title">Dialogue Prompt</h2>
        <p class="chart-description">This is the prompt used to generate the synthetic conversations in this dataset.</p>
        <div class="prompt-container">
            <div id="loading-prompt" class="loading">
                <div class="spinner"></div>
                <div>Loading prompt...</div>
            </div>
            <pre id="prompt-content" class="prompt-text"></pre>
        </div>
    </div>

    <div class="chart-section">
        <h2 class="chart-title">Generation Config</h2>
        <p class="chart-description">This is the configuration used for generating the synthetic conversations in this dataset.</p>
        <div class="prompt-container">
            <div id="loading-config" class="loading">
                <div class="spinner"></div>
                <div>Loading config...</div>
            </div>
            <pre id="config-content" class="prompt-text"></pre>
        </div>
    </div>

    <div class="stats-container">
        <div class="stats-card">
            <h2 class="chart-title">Post Count Statistics</h2>
            <p class="stats-description">Number of posts in each topic. Original vs. synthetic conversations.</p>
            <table id="message-stats">
                <tr>
                    <th>Metric</th>
                    <th>Original</th>
                    <th>Synthetic</th>
                </tr>
                <tr>
                    <td>Average</td>
                    <td id="orig-msg-avg">-</td>
                    <td id="synth-msg-avg">-</td>
                </tr>
                <tr>
                    <td>Median</td>
                    <td id="orig-msg-median">-</td>
                    <td id="synth-msg-median">-</td>
                </tr>
                <tr>
                    <td>Min</td>
                    <td id="orig-msg-min">-</td>
                    <td id="synth-msg-min">-</td>
                </tr>
                <tr>
                    <td>Max</td>
                    <td id="orig-msg-max">-</td>
                    <td id="synth-msg-max">-</td>
                </tr>
                <tr>
                    <td>Correlation</td>
                    <td colspan="2" id="msg-correlation">-</td>
                </tr>
            </table>
        </div>
        
        <div class="stats-card">
            <h2 class="chart-title">Character Statistics</h2>
            <p class="stats-description">Shows the length of original vs. synthetic posts in terms of characters.</p>
            <table id="char-stats">
                <tr>
                    <th>Metric</th>
                    <th>Original</th>
                    <th>Synthetic</th>
                </tr>
                <tr>
                    <td>Avg Chars/Post</td>
                    <td id="orig-chars-avg">-</td>
                    <td id="synth-chars-avg">-</td>
                </tr>
                <tr>
                    <td>Total Chars</td>
                    <td id="orig-chars-total">-</td>
                    <td id="synth-chars-total">-</td>
                </tr>
                <tr>
                    <td>Min Chars</td>
                    <td id="orig-chars-min">-</td>
                    <td id="synth-chars-min">-</td>
                </tr>
                <tr>
                    <td>Max Chars</td>
                    <td id="orig-chars-max">-</td>
                    <td id="synth-chars-max">-</td>
                </tr>
                <tr>
                    <td>Char Ratio</td>
                    <td colspan="2" id="char-ratio">-</td>
                </tr>
            </table>
        </div>
        
        <div class="stats-card">
            <h2 class="chart-title">Token Statistics</h2>
            <p class="stats-description"><strong>ESTIMATED</strong> token counts in posts. Formula: tokens ≈ words × 1.3 (roughly 1 token ≈ 4 characters or 0.75 words). These are approximations, not exact tokenizer counts.</p>
            <table id="token-stats-table">
                <tr>
                    <th>Metric</th>
                    <th>Original</th>
                    <th>Synthetic</th>
                </tr>
                <tr>
                    <td>Avg Tokens/Post</td>
                    <td id="orig-tokens-avg">-</td>
                    <td id="synth-tokens-avg">-</td>
                </tr>
                <tr>
                    <td>Total Tokens</td>
                    <td id="orig-tokens-total">-</td>
                    <td id="synth-tokens-total">-</td>
                </tr>
                <tr>
                    <td>Max Tokens/Post</td>
                    <td id="orig-tokens-max">-</td>
                    <td id="synth-tokens-max">-</td>
                </tr>
                <tr>
                    <td>Total Tokens (Sum)</td>
                    <td id="orig-tokens-sum">-</td>
                    <td id="synth-tokens-sum">-</td>
                </tr>
                <tr>
                    <td>Token Ratio</td>
                    <td colspan="2" id="token-ratio">-</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="stats-container">
        <div class="stats-card">
            <h2 class="chart-title">Content Statistics</h2>
            <p class="stats-description">Word counts and ratios. How words relate to characters and tokens in original vs. synthetic messages.</p>
            <table id="content-stats">
                <tr>
                    <th>Metric</th>
                    <th>Original</th>
                    <th>Synthetic</th>
                </tr>
                <tr>
                    <td>Avg Words/Post</td>
                    <td id="orig-words-avg">-</td>
                    <td id="synth-words-avg">-</td>
                </tr>
                <tr>
                    <td>Total Words</td>
                    <td id="orig-words-total">-</td>
                    <td id="synth-words-total">-</td>
                </tr>
                <tr>
                    <td>Words/Char Ratio</td>
                    <td id="orig-words-char-ratio">-</td>
                    <td id="synth-words-char-ratio">-</td>
                </tr>
                <tr>
                    <td>Words/Token Ratio</td>
                    <td id="orig-words-token-ratio">-</td>
                    <td id="synth-words-token-ratio">-</td>
                </tr>
            </table>
        </div>
        
        <div class="stats-card">
            <h2 class="chart-title">Context Statistics</h2>
            <p class="stats-description">Context usage during generation. Available vs. used.</p>
            <table id="context-stats-table">
                <tr>
                    <th>Metric</th>
                    <th>Used</th>
                    <th>Available</th>
                </tr>
                <tr>
                    <td>Messages (Avg)</td>
                    <td id="context-msg-used-avg">-</td>
                    <td id="context-msg-avail-avg">-</td>
                </tr>
                <tr>
                    <td>Messages (Min)</td>
                    <td id="context-msg-used-min">-</td>
                    <td id="context-msg-avail-min">-</td>
                </tr>
                <tr>
                    <td>Messages (Max)</td>
                    <td id="context-msg-used-max">-</td>
                    <td id="context-msg-avail-max">-</td>
                </tr>
                <tr>
                    <td>Messages (Sum)</td>
                    <td id="context-msg-used-sum">-</td>
                    <td id="context-msg-avail-sum">-</td>
                </tr>
                <tr>
                    <td>Tokens (Avg)</td>
                    <td id="context-token-used-avg">-</td>
                    <td id="context-token-avail-avg">-</td>
                </tr>
                <tr>
                    <td>Tokens (Min)</td>
                    <td id="context-token-used-min">-</td>
                    <td id="context-token-avail-min">-</td>
                </tr>
                <tr>
                    <td>Tokens (Max)</td>
                    <td id="context-token-used-max">-</td>
                    <td id="context-token-avail-max">-</td>
                </tr>
                <tr>
                    <td>Tokens (Sum)</td>
                    <td id="context-token-used-sum">-</td>
                    <td id="context-token-avail-sum">-</td>
                </tr>
            </table>
        </div>
        
        <div class="stats-card">
            <h2 class="chart-title">Distribution Tests</h2>
            <p class="stats-description">Statistical tests comparing original and synthetic distributions. Significant = difference.</p>
            <table id="stat-tests">
                <tr>
                    <th>Metric</th>
                    <th>Test</th>
                    <th>Result</th>
                    <th>Significant?</th>
                </tr>
                <tr>
                    <td>Post Counts</td>
                    <td>Kolmogorov-Smirnov</td>
                    <td id="ks-message-result">-</td>
                    <td id="ks-message-sig">-</td>
                </tr>
                <tr>
                    <td>Post Counts</td>
                    <td>Mann-Whitney U</td>
                    <td id="mw-message-result">-</td>
                    <td id="mw-message-sig">-</td>
                </tr>
                <tr>
                    <td>Character Counts</td>
                    <td>Kolmogorov-Smirnov</td>
                    <td id="ks-char-result">-</td>
                    <td id="ks-char-sig">-</td>
                </tr>
                <tr>
                    <td>Length Distribution</td>
                    <td>Chi-Square</td>
                    <td id="chi-length-result">-</td>
                    <td id="chi-length-sig">-</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="chart-section">
        <h2 class="chart-title">Word Error Rate Distribution</h2>
        <p class="chart-description">This histogram shows the distribution of Word Error Rate (WER) between original and synthetic conversations. WER is calculated after removing speaker identifiers like "Person 1:".</p>
        <div class="chart-container">
            <div id="loading-wer-dist" class="loading">
                <div class="spinner"></div>
                <div>Loading chart data...</div>
            </div>
            <canvas id="werDistChart"></canvas>
        </div>
    </div>

    <div class="stats-container">
        <div class="stats-card">
            <h2 class="chart-title">Word Error Rate Statistics</h2>
            <p class="stats-description">Word Error Rate (WER) between original and synthetic posts, excluding speaker identifiers.</p>
            <table id="wer-stats-table">
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
                <tr>
                    <td>Average WER</td>
                    <td id="wer-avg">-</td>
                </tr>
                <tr>
                    <td>Median WER</td>
                    <td id="wer-median">-</td>
                </tr>
                <tr>
                    <td>Min WER</td>
                    <td id="wer-min">-</td>
                </tr>
                <tr>
                    <td>Max WER</td>
                    <td id="wer-max">-</td>
                </tr>
                <tr>
                    <td>Standard Deviation</td>
                    <td id="wer-std">-</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="chart-section">
        <h2 class="chart-title">Post Count Comparison</h2>
        <p class="chart-description">This scatter plot shows the relationship between the number of posts in original conversations (x-axis) and synthetic conversations (y-axis). Each point represents one conversation thread.</p>
        <div class="chart-container">
            <div id="loading-msg-count" class="loading">
                <div class="spinner"></div>
                <div>Loading chart data...</div>
            </div>
            <canvas id="messageCountChart"></canvas>
        </div>
    </div>

    <div class="chart-section">
        <h2 class="chart-title">Post Character Distribution</h2>
        <p class="chart-description">This histogram shows the distribution of post character counts for both original and synthetic posts. The x-axis shows character count ranges, and the y-axis shows the frequency (number of posts).</p>
        <div class="chart-container">
            <div id="loading-msg-length" class="loading">
                <div class="spinner"></div>
                <div>Loading chart data...</div>
            </div>
            <canvas id="messageLengthChart"></canvas>
        </div>
    </div>

    <div class="chart-section">
        <h2 class="chart-title">ESTIMATED Token Distribution</h2>
        <p class="chart-description">This histogram shows the distribution of estimated token counts for both original and synthetic posts. Tokens are calculated as words × 1.3, not using an actual tokenizer.</p>
        <div class="chart-container">
            <div id="loading-token-dist" class="loading">
                <div class="spinner"></div>
                <div>Loading chart data...</div>
            </div>
            <canvas id="tokenDistChart"></canvas>
        </div>
    </div>

    <div class="chart-section">
        <h2 class="chart-title">User Count Comparison</h2>
        <p class="chart-description">This bar chart compares the number of unique users in original and synthetic conversations. The x-axis shows the number of users per conversation thread, and the y-axis shows how many conversations have that number of users.</p>
        <div class="chart-container">
            <div id="loading-user-count" class="loading">
                <div class="spinner"></div>
                <div>Loading chart data...</div>
            </div>
            <canvas id="userCountChart"></canvas>
        </div>
    </div>

    <div class="chart-section">
        <h2 class="chart-title">Context Usage</h2>
        <p class="chart-description">This scatter plot shows the relationship between available context messages (x-axis) and used context messages (y-axis). Each point represents one conversation.</p>
        <div class="chart-container">
            <div id="loading-context-usage" class="loading">
                <div class="spinner"></div>
                <div>Loading chart data...</div>
            </div>
            <canvas id="contextUsageChart"></canvas>
        </div>
    </div>

    <script>
        // Function to fetch dataset statistics
        async function fetchDatasetStats() {
            try {
                const response = await fetch('/dataset_stats');
                const stats = await response.json();
                
                // Update dataset info at the top of the page
                if (stats.dataset_info) {
                    const datasetInfoElement = document.getElementById('dataset-info');
                    datasetInfoElement.innerHTML = `Dataset: ${stats.dataset_info.dataset_id || 'Unknown'}<br>Conversations: ${stats.dataset_info.conversation_count || 0}`;
                }
                
                // Update the statistics tables
                updateStatsTables(stats);
                
                // Create the charts
                createMessageCountChart(stats.message_counts);
                createMessageLengthChart(stats.message_lengths);
                createTokenDistChart(stats.message_lengths);
                createUserCountChart(stats.user_counts);
                createContextUsageChart(stats.context_stats);
                
                // Calculate and display WER statistics
                if (stats.conversations && stats.conversations.length > 0) {
                    const werStats = calculateWERStats(stats.conversations);
                    
                    // Update WER statistics table
                    document.getElementById('wer-avg').textContent = (werStats.avg * 100).toFixed(2) + '%';
                    document.getElementById('wer-median').textContent = (werStats.median * 100).toFixed(2) + '%';
                    document.getElementById('wer-min').textContent = (werStats.min * 100).toFixed(2) + '%';
                    document.getElementById('wer-max').textContent = (werStats.max * 100).toFixed(2) + '%';
                    document.getElementById('wer-std').textContent = (werStats.std * 100).toFixed(2) + '%';
                    
                    // Create WER distribution chart
                    createWERDistChart(werStats.values);
                }
                
            } catch (error) {
                console.error('Error fetching dataset statistics:', error);
                document.getElementById('dataset-info').textContent = `Error: ${error.message}`;
            }
        }
        
        // Function to update the statistics tables
        function updateStatsTables(stats) {
            // Message count statistics
            document.getElementById('orig-msg-avg').textContent = stats.message_counts.orig_avg.toFixed(2);
            document.getElementById('synth-msg-avg').textContent = stats.message_counts.synth_avg.toFixed(2);
            document.getElementById('orig-msg-median').textContent = stats.message_counts.orig_median.toFixed(2);
            document.getElementById('synth-msg-median').textContent = stats.message_counts.synth_median.toFixed(2);
            document.getElementById('orig-msg-min').textContent = stats.message_counts.orig_min;
            document.getElementById('synth-msg-min').textContent = stats.message_counts.synth_min;
            document.getElementById('orig-msg-max').textContent = stats.message_counts.orig_max;
            document.getElementById('synth-msg-max').textContent = stats.message_counts.synth_max;
            document.getElementById('msg-correlation').textContent = stats.message_counts.correlation.toFixed(3);
            
            // Character statistics
            document.getElementById('orig-chars-avg').textContent = stats.message_lengths.orig_chars_avg.toFixed(2);
            document.getElementById('synth-chars-avg').textContent = stats.message_lengths.synth_chars_avg.toFixed(2);
            document.getElementById('orig-chars-total').textContent = stats.message_lengths.orig_chars_total.toLocaleString();
            document.getElementById('synth-chars-total').textContent = stats.message_lengths.synth_chars_total.toLocaleString();
            
            // Calculate min/max character counts if available
            const origCharMin = Math.min(...stats.message_lengths.orig_lengths);
            const synthCharMin = Math.min(...stats.message_lengths.synth_lengths);
            const origCharMax = Math.max(...stats.message_lengths.orig_lengths);
            const synthCharMax = Math.max(...stats.message_lengths.synth_lengths);
            
            document.getElementById('orig-chars-min').textContent = origCharMin.toLocaleString();
            document.getElementById('synth-chars-min').textContent = synthCharMin.toLocaleString();
            document.getElementById('orig-chars-max').textContent = origCharMax.toLocaleString();
            document.getElementById('synth-chars-max').textContent = synthCharMax.toLocaleString();
            
            // Calculate and display the character ratio (synthetic/original)
            const charRatio = stats.message_lengths.orig_chars_total > 0 ? 
                (stats.message_lengths.synth_chars_total / stats.message_lengths.orig_chars_total).toFixed(2) : '-';
            document.getElementById('char-ratio').textContent = charRatio;
            
            // Content statistics (words)
            document.getElementById('orig-words-avg').textContent = stats.message_lengths.orig_words_avg.toFixed(2);
            document.getElementById('synth-words-avg').textContent = stats.message_lengths.synth_words_avg.toFixed(2);
            document.getElementById('orig-words-total').textContent = stats.message_lengths.orig_words_total.toLocaleString();
            document.getElementById('synth-words-total').textContent = stats.message_lengths.synth_words_total.toLocaleString();
            
            // Calculate words/char ratio
            const origWordsCharRatio = stats.message_lengths.orig_chars_total > 0 ? 
                (stats.message_lengths.orig_words_total / stats.message_lengths.orig_chars_total).toFixed(3) : '-';
            const synthWordsCharRatio = stats.message_lengths.synth_chars_total > 0 ? 
                (stats.message_lengths.synth_words_total / stats.message_lengths.synth_chars_total).toFixed(3) : '-';
            
            document.getElementById('orig-words-char-ratio').textContent = origWordsCharRatio;
            document.getElementById('synth-words-char-ratio').textContent = synthWordsCharRatio;
            
            // Token statistics (estimated based on words)
            const origTokensAvg = stats.message_lengths.orig_words_avg * 1.3;
            const synthTokensAvg = stats.message_lengths.synth_words_avg * 1.3;
            const origTokensTotal = Math.round(stats.message_lengths.orig_words_total * 1.3);
            const synthTokensTotal = Math.round(stats.message_lengths.synth_words_total * 1.3);

            // Calculate max tokens (based on max words)
            const origWordsArray = stats.message_lengths.orig_words;
            const synthWordsArray = stats.message_lengths.synth_words;
            const origTokensMax = Math.round(Math.max(...origWordsArray) * 1.3);
            const synthTokensMax = Math.round(Math.max(...synthWordsArray) * 1.3);

            // Calculate sum of all tokens across all conversations
            const origTokensSum = origTokensTotal;
            const synthTokensSum = synthTokensTotal;

            document.getElementById('orig-tokens-avg').textContent = origTokensAvg.toFixed(2);
            document.getElementById('synth-tokens-avg').textContent = synthTokensAvg.toFixed(2);
            document.getElementById('orig-tokens-total').textContent = origTokensTotal.toLocaleString();
            document.getElementById('synth-tokens-total').textContent = synthTokensTotal.toLocaleString();
            document.getElementById('orig-tokens-max').textContent = origTokensMax.toLocaleString();
            document.getElementById('synth-tokens-max').textContent = synthTokensMax.toLocaleString();
            document.getElementById('orig-tokens-sum').textContent = origTokensSum.toLocaleString();
            document.getElementById('synth-tokens-sum').textContent = synthTokensSum.toLocaleString();
            
            // Calculate and display the token ratio (synthetic/original)
            const tokenRatio = origTokensTotal > 0 ? (synthTokensTotal / origTokensTotal).toFixed(2) : '-';
            document.getElementById('token-ratio').textContent = tokenRatio;
            
            // Calculate words/token ratio
            const origWordsTokenRatio = origTokensTotal > 0 ? 
                (stats.message_lengths.orig_words_total / origTokensTotal).toFixed(3) : '-';
            const synthWordsTokenRatio = synthTokensTotal > 0 ? 
                (stats.message_lengths.synth_words_total / synthTokensTotal).toFixed(3) : '-';
            
            document.getElementById('orig-words-token-ratio').textContent = origWordsTokenRatio;
            document.getElementById('synth-words-token-ratio').textContent = synthWordsTokenRatio;
            
            // Run statistical tests
            try {
                // Kolmogorov-Smirnov test for message counts
                const ksMessageTest = kolmogorovSmirnovTest(
                    stats.message_counts.orig_counts,
                    stats.message_counts.synth_counts
                );
                document.getElementById('ks-message-result').textContent = 
                    `D = ${ksMessageTest.statistic.toFixed(3)}`;
                document.getElementById('ks-message-sig').textContent = 
                    ksMessageTest.significant ? 'Yes (p<0.05)' : 'No';
                
                // Kolmogorov-Smirnov test for character counts
                const ksCharTest = kolmogorovSmirnovTest(
                    stats.message_lengths.orig_lengths,
                    stats.message_lengths.synth_lengths
                );
                document.getElementById('ks-char-result').textContent = 
                    `D = ${ksCharTest.statistic.toFixed(3)}`;
                document.getElementById('ks-char-sig').textContent = 
                    ksCharTest.significant ? 'Yes (p<0.05)' : 'No';
                
                // Chi-Square test for message length distribution
                const chiLengthTest = chiSquareTest(
                    stats.message_lengths.orig_hist,
                    stats.message_lengths.synth_hist
                );
                document.getElementById('chi-length-result').textContent = 
                    `χ² = ${chiLengthTest.statistic.toFixed(2)}, df = ${chiLengthTest.degreesOfFreedom}`;
                document.getElementById('chi-length-sig').textContent = 
                    chiLengthTest.significant ? 'Yes (p<0.05)' : 'No';
                
                // Mann-Whitney U test for message counts
                const mwMessageTest = mannWhitneyUTest(
                    stats.message_counts.orig_counts,
                    stats.message_counts.synth_counts
                );
                document.getElementById('mw-message-result').textContent = 
                    `U = ${mwMessageTest.u.toFixed(0)}, z = ${mwMessageTest.z.toFixed(2)}`;
                document.getElementById('mw-message-sig').textContent = 
                    mwMessageTest.significant ? 'Yes (p<0.05)' : 'No';
            } catch (error) {
                console.error('Error calculating statistical tests:', error);
                document.getElementById('ks-message-result').textContent = 'Error';
                document.getElementById('ks-char-result').textContent = 'Error';
                document.getElementById('chi-length-result').textContent = 'Error';
                document.getElementById('mw-message-result').textContent = 'Error';
            }
            
            // Add context statistics
            if (stats.context_stats) {
                // Get values from the context stats
                const msgUsed = stats.context_stats.used_avg ? stats.context_stats.used_avg.toFixed(2) : 'N/A';
                const msgAvail = stats.context_stats.avail_avg ? stats.context_stats.avail_avg.toFixed(2) : 'N/A';
                const tokensUsed = stats.context_stats.tokens_used_avg ? stats.context_stats.tokens_used_avg.toFixed(2) : 'N/A';
                
                // Get min values
                const msgUsedMin = stats.context_stats.used_min !== undefined ? stats.context_stats.used_min : 'N/A';
                const msgAvailMin = stats.context_stats.avail_min !== undefined ? stats.context_stats.avail_min : 'N/A';
                const tokensUsedMin = stats.context_stats.tokens_used_min !== undefined ? stats.context_stats.tokens_used_min : 'N/A';
                
                // Get max values
                const msgUsedMax = stats.context_stats.used_max !== undefined ? stats.context_stats.used_max : 'N/A';
                const msgAvailMax = stats.context_stats.avail_max !== undefined ? stats.context_stats.avail_max : 'N/A';
                const tokensUsedMax = stats.context_stats.tokens_used_max !== undefined ? stats.context_stats.tokens_used_max : 'N/A';
                const tokensAvailMax = stats.context_stats.tokens_avail_max !== undefined ? stats.context_stats.tokens_avail_max : 'N/A';
                
                // Calculate sum values
                const msgUsedSum = stats.context_stats.used_sum !== undefined ? 
                    stats.context_stats.used_sum.toLocaleString() : 
                    (stats.context_stats.used_avg && stats.dataset_info.conversation_count ? 
                        Math.round(stats.context_stats.used_avg * stats.dataset_info.conversation_count).toLocaleString() : 'N/A');
                
                const msgAvailSum = stats.context_stats.avail_sum !== undefined ? 
                    stats.context_stats.avail_sum.toLocaleString() : 
                    (stats.context_stats.avail_avg && stats.dataset_info.conversation_count ? 
                        Math.round(stats.context_stats.avail_avg * stats.dataset_info.conversation_count).toLocaleString() : 'N/A');
                
                const tokensUsedSum = stats.context_stats.tokens_used_sum !== undefined ? 
                    stats.context_stats.tokens_used_sum.toLocaleString() : 
                    (stats.context_stats.tokens_used_avg && stats.dataset_info.conversation_count ? 
                        Math.round(stats.context_stats.tokens_used_avg * stats.dataset_info.conversation_count).toLocaleString() : 'N/A');
                
                // Update the context statistics table
                document.getElementById('context-msg-used-avg').textContent = msgUsed;
                document.getElementById('context-msg-avail-avg').textContent = msgAvail;
                document.getElementById('context-msg-used-min').textContent = msgUsedMin;
                document.getElementById('context-msg-avail-min').textContent = msgAvailMin;
                document.getElementById('context-msg-used-max').textContent = msgUsedMax;
                document.getElementById('context-msg-avail-max').textContent = msgAvailMax;
                document.getElementById('context-msg-used-sum').textContent = msgUsedSum;
                document.getElementById('context-msg-avail-sum').textContent = msgAvailSum;
                
                document.getElementById('context-token-used-avg').textContent = tokensUsed;
                document.getElementById('context-token-avail-avg').textContent = 'N/A';
                document.getElementById('context-token-used-min').textContent = tokensUsedMin;
                document.getElementById('context-token-avail-min').textContent = 'N/A';
                document.getElementById('context-token-used-max').textContent = tokensUsedMax;
                document.getElementById('context-token-avail-max').textContent = tokensAvailMax;
                document.getElementById('context-token-used-sum').textContent = tokensUsedSum;
                document.getElementById('context-token-avail-sum').textContent = 'N/A';
            } else {
                console.log("No context stats available, showing N/A");
                // If no context stats available, show "N/A"
                const contextCells = document.querySelectorAll('#context-stats-table td:not(:first-child)');
                contextCells.forEach(cell => {
                    cell.textContent = 'N/A';
                });
            }
        }
        
        // Function to create the message count chart
        function createMessageCountChart(data) {
            const ctx = document.getElementById('messageCountChart').getContext('2d');
            
            // Hide loading indicator
            document.getElementById('loading-msg-count').style.display = 'none';
            
            // Create scatter plot
            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Conversations',
                        data: data.scatter_data,
                        backgroundColor: 'rgba(233, 84, 32, 0.6)',
                        borderColor: 'rgba(233, 84, 32, 1)',
                        borderWidth: 1,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Number of Posts in Original Conversation',
                                color: '#E95420',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#FFF'
                            },
                            grid: {
                                color: 'rgba(119, 41, 83, 0.3)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Posts in Synthetic Conversation',
                                color: '#E95420',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#FFF'
                            },
                            grid: {
                                color: 'rgba(119, 41, 83, 0.3)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#FFF'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Conversation ID: ${context.raw.id}, Original: ${context.raw.x} posts, Synthetic: ${context.raw.y} posts`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Function to create the message length chart
        function createMessageLengthChart(data) {
            const ctx = document.getElementById('messageLengthChart').getContext('2d');
            
            // Hide loading indicator
            document.getElementById('loading-msg-length').style.display = 'none';
            
            // Create histogram data
            const bins = data.bins;
            const origHist = data.orig_hist;
            const synthHist = data.synth_hist;
            
            // Create labels for the chart (bin ranges)
            const labels = [];
            for (let i = 0; i < bins.length; i++) {
                if (i % 4 === 0) {  // Only show every 4th label to avoid crowding
                    labels.push(bins[i]);
                } else {
                    labels.push('');
                }
            }
            
            // Create bar chart
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Original Posts',
                            data: origHist,
                            backgroundColor: 'rgba(53, 162, 235, 0.5)',
                            borderColor: 'rgba(53, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Synthetic Posts',
                            data: synthHist,
                            backgroundColor: 'rgba(233, 84, 32, 0.5)',
                            borderColor: 'rgba(233, 84, 32, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Characters per Post',
                                color: '#E95420',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#FFF',
                                callback: function(value, index) {
                                    // Show fewer labels for readability
                                    return index % 4 === 0 ? this.getLabelForValue(value) : '';
                                }
                            },
                            grid: {
                                color: 'rgba(119, 41, 83, 0.3)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Posts',
                                color: '#E95420',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#FFF'
                            },
                            grid: {
                                color: 'rgba(119, 41, 83, 0.3)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#FFF'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const item = tooltipItems[0];
                                    const bin = bins[item.dataIndex];
                                    return `${bin}-${bin+50} characters`;
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw} posts`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Function to create the token distribution chart
        function createTokenDistChart(data) {
            const ctx = document.getElementById('tokenDistChart').getContext('2d');
            
            // Hide loading indicator
            document.getElementById('loading-token-dist').style.display = 'none';
            
            // Create token bins (convert character bins to token bins)
            const tokenBins = data.bins.map(bin => Math.round(bin * 0.25));
            
            // Create histogram data
            const origHist = data.orig_hist;
            const synthHist = data.synth_hist;
            
            // Create labels for the chart (bin ranges)
            const labels = [];
            for (let i = 0; i < tokenBins.length; i++) {
                if (i % 4 === 0) {  // Only show every 4th label to avoid crowding
                    labels.push(tokenBins[i]);
                } else {
                    labels.push('');
                }
            }
            
            // Create bar chart
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Original Posts',
                            data: origHist,
                            backgroundColor: 'rgba(53, 162, 235, 0.5)',
                            borderColor: 'rgba(53, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Synthetic Posts',
                            data: synthHist,
                            backgroundColor: 'rgba(233, 84, 32, 0.5)',
                            borderColor: 'rgba(233, 84, 32, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Tokens per Post',
                                color: '#E95420',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#FFF',
                                callback: function(value, index) {
                                    // Show fewer labels for readability
                                    return index % 4 === 0 ? this.getLabelForValue(value) : '';
                                }
                            },
                            grid: {
                                color: 'rgba(119, 41, 83, 0.3)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Posts',
                                color: '#E95420',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#FFF'
                            },
                            grid: {
                                color: 'rgba(119, 41, 83, 0.3)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#FFF'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    const item = tooltipItems[0];
                                    const bin = tokenBins[item.dataIndex];
                                    return `${bin}-${bin+25} tokens`;
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw} posts`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Function to create the user count chart
        function createUserCountChart(data) {
            const ctx = document.getElementById('userCountChart').getContext('2d');
            
            // Hide loading indicator
            document.getElementById('loading-user-count').style.display = 'none';
            
            console.log("User count data:", data);
            
            // Check if we have the necessary data
            if (!data || !data.orig_counts || !data.synth_counts || 
                data.orig_counts.length === 0 || data.synth_counts.length === 0) {
                console.log("No user count data available");
                
                // Display a message on the canvas
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['No Data Available'],
                        datasets: [{
                            label: 'No user count data available',
                            data: [0],
                            backgroundColor: 'rgba(119, 41, 83, 0.2)',
                            borderColor: 'rgba(119, 41, 83, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        }
                    }
                });
                
                return;
            }
            
            // Create labels for the chart
            const labels = ['1 user', '2 users', '3 users', '4 users', '5 users', '6+ users'];
            
            // Ensure we have the right number of data points
            const origCounts = data.orig_counts.slice(0, 6);
            const synthCounts = data.synth_counts.slice(0, 6);
            
            // Pad arrays if they're too short
            while (origCounts.length < 6) origCounts.push(0);
            while (synthCounts.length < 6) synthCounts.push(0);
            
            // Create bar chart
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Original Conversations',
                            data: origCounts,
                            backgroundColor: 'rgba(53, 162, 235, 0.5)',
                            borderColor: 'rgba(53, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Synthetic Conversations',
                            data: synthCounts,
                            backgroundColor: 'rgba(233, 84, 32, 0.5)',
                            borderColor: 'rgba(233, 84, 32, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Number of Unique Users per Conversation Thread',
                                color: '#E95420',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#FFF'
                            },
                            grid: {
                                color: 'rgba(119, 41, 83, 0.3)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Conversations',
                                color: '#E95420',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#FFF'
                            },
                            grid: {
                                color: 'rgba(119, 41, 83, 0.3)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#FFF'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw} conversations`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Function to load and display the prompt file
        async function loadPromptFile() {
            try {
                const response = await fetch('/prompt_file');
                if (!response.ok) {
                    throw new Error('Failed to fetch prompt file');
                }
                
                const promptText = await response.text();
                document.getElementById('prompt-content').textContent = promptText;
                document.getElementById('loading-prompt').style.display = 'none';
            } catch (error) {
                console.error('Error loading prompt file:', error);
                document.getElementById('prompt-content').textContent = 'Error loading prompt file: ' + error.message;
                document.getElementById('loading-prompt').style.display = 'none';
            }
        }
        
        // Function to load and display the config file
        async function loadConfigFile() {
            try {
                const response = await fetch('/config_file');
                if (!response.ok) {
                    throw new Error('Failed to fetch config file');
                }
                
                const configData = await response.json();
                document.getElementById('config-content').textContent = JSON.stringify(configData, null, 2);
                document.getElementById('loading-config').style.display = 'none';
            } catch (error) {
                console.error('Error loading config file:', error);
                document.getElementById('config-content').textContent = 'Error loading config file: ' + error.message;
                document.getElementById('loading-config').style.display = 'none';
            }
        }
        
        // Function to perform Kolmogorov-Smirnov test
        function kolmogorovSmirnovTest(sample1, sample2) {
            // Sort the samples
            sample1 = sample1.slice().sort((a, b) => a - b);
            sample2 = sample2.slice().sort((a, b) => a - b);
            
            // Create empirical CDFs
            const n1 = sample1.length;
            const n2 = sample2.length;
            
            // Combine samples for comparison
            const combined = [...sample1, ...sample2].sort((a, b) => a - b);
            const uniqueValues = [...new Set(combined)];
            
            // Calculate maximum difference
            let maxDiff = 0;
            
            for (const value of uniqueValues) {
                // Count values less than or equal to current value
                const count1 = sample1.filter(x => x <= value).length;
                const count2 = sample2.filter(x => x <= value).length;
                
                // Calculate empirical CDFs
                const cdf1 = count1 / n1;
                const cdf2 = count2 / n2;
                
                // Update maximum difference
                const diff = Math.abs(cdf1 - cdf2);
                if (diff > maxDiff) {
                    maxDiff = diff;
                }
            }
            
            // Calculate critical value (approximate for large samples)
            const criticalValue = 1.36 * Math.sqrt((n1 + n2) / (n1 * n2));
            
            return {
                statistic: maxDiff,
                criticalValue: criticalValue,
                significant: maxDiff > criticalValue
            };
        }
        
        // Function to perform Chi-Square test
        function chiSquareTest(observed1, observed2) {
            // Ensure both arrays have the same length (same number of bins)
            if (observed1.length !== observed2.length) {
                throw new Error("Both distributions must have the same number of bins");
            }
            
            // Calculate total observations
            const total1 = observed1.reduce((sum, val) => sum + val, 0);
            const total2 = observed2.reduce((sum, val) => sum + val, 0);
            
            // Calculate chi-square statistic
            let chiSquare = 0;
            const degreesOfFreedom = observed1.length - 1;
            
            for (let i = 0; i < observed1.length; i++) {
                // Skip bins with zero observations in both distributions
                if (observed1[i] === 0 && observed2[i] === 0) continue;
                
                // Calculate expected values (proportional to totals)
                const expected1 = (observed1[i] + observed2[i]) * (total1 / (total1 + total2));
                const expected2 = (observed1[i] + observed2[i]) * (total2 / (total1 + total2));
                
                // Add to chi-square statistic if expected values are non-zero
                if (expected1 > 0) {
                    chiSquare += Math.pow(observed1[i] - expected1, 2) / expected1;
                }
                if (expected2 > 0) {
                    chiSquare += Math.pow(observed2[i] - expected2, 2) / expected2;
                }
            }
            
            // Critical value for 95% confidence (would need a lookup table for exact values)
            // This is an approximation
            const criticalValue = degreesOfFreedom + Math.sqrt(2 * degreesOfFreedom);
            
            return {
                statistic: chiSquare,
                degreesOfFreedom: degreesOfFreedom,
                criticalValue: criticalValue,
                significant: chiSquare > criticalValue
            };
        }
        
        // Function to perform Mann-Whitney U test
        function mannWhitneyUTest(sample1, sample2) {
            // Combine samples and assign ranks
            const combined = [...sample1.map(x => ({value: x, group: 1})), 
                              ...sample2.map(x => ({value: x, group: 2}))];
            
            // Sort by value
            combined.sort((a, b) => a.value - b.value);
            
            // Assign ranks (handling ties)
            let currentRank = 1;
            for (let i = 0; i < combined.length; i++) {
                let j = i;
                // Find ties
                while (j < combined.length - 1 && combined[j].value === combined[j + 1].value) {
                    j++;
                }
                
                // Assign average rank for ties
                const averageRank = currentRank + (j - i) / 2;
                for (let k = i; k <= j; k++) {
                    combined[k].rank = averageRank;
                }
                
                currentRank = j + 2;
                i = j;
            }
            
            // Calculate rank sums
            const n1 = sample1.length;
            const n2 = sample2.length;
            
            const rankSum1 = combined.filter(x => x.group === 1).reduce((sum, x) => sum + x.rank, 0);
            
            // Calculate U statistic
            const u1 = rankSum1 - (n1 * (n1 + 1)) / 2;
            const u2 = n1 * n2 - u1;
            
            // Use smaller U value
            const u = Math.min(u1, u2);
            
            // Calculate mean and standard deviation of U
            const meanU = n1 * n2 / 2;
            const stdU = Math.sqrt((n1 * n2 * (n1 + n2 + 1)) / 12);
            
            // Calculate z-score for normal approximation
            const z = (u - meanU) / stdU;
            
            return {
                u: u,
                z: z,
                significant: Math.abs(z) > 1.96 // 95% confidence
            };
        }
        
        // Function to create the context usage chart
        function createContextUsageChart(contextStats) {
            const ctx = document.getElementById('contextUsageChart').getContext('2d');
            
            // Hide loading indicator
            document.getElementById('loading-context-usage').style.display = 'none';
            
            // Prepare data for scatter plot
            const scatterData = [];
            
            console.log("Context stats for chart:", contextStats);
            
            // Check if we have the necessary arrays
            if (contextStats.used_counts && contextStats.avail_counts && 
                contextStats.used_counts.length === contextStats.avail_counts.length) {
                
                for (let i = 0; i < contextStats.used_counts.length; i++) {
                    // Only add points where at least one value is non-zero
                    if (contextStats.used_counts[i] > 0 || contextStats.avail_counts[i] > 0) {
                        scatterData.push({
                            x: contextStats.avail_counts[i],
                            y: contextStats.used_counts[i]
                        });
                    }
                }
                
                console.log(`Found ${scatterData.length} non-zero context points out of ${contextStats.used_counts.length} total`);
            }
            
            // Create scatter plot
            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Context Usage',
                        data: scatterData,
                        backgroundColor: 'rgba(119, 41, 83, 0.6)',
                        borderColor: 'rgba(119, 41, 83, 1)',
                        borderWidth: 1,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Available Context Messages',
                                color: '#E95420',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#FFF'
                            },
                            grid: {
                                color: 'rgba(119, 41, 83, 0.3)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Used Context Messages',
                                color: '#E95420',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#FFF'
                            },
                            grid: {
                                color: 'rgba(119, 41, 83, 0.3)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#FFF'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Available: ${context.raw.x}, Used: ${context.raw.y}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Function to calculate WER between two strings
        function calculateWER(original, generated) {
            // Remove speaker identifiers like "Person 1:" from both strings
            const cleanOriginal = original.replace(/Person \d+:/g, '').trim();
            const cleanGenerated = generated.replace(/Person \d+:/g, '').trim();
            
            // Split into words
            const origWords = cleanOriginal.split(/\s+/);
            const genWords = cleanGenerated.split(/\s+/);
            
            // Initialize the distance matrix
            const dp = Array(origWords.length + 1).fill().map(() => Array(genWords.length + 1).fill(0));
            
            // Fill the first row and column
            for (let i = 0; i <= origWords.length; i++) dp[i][0] = i;
            for (let j = 0; j <= genWords.length; j++) dp[0][j] = j;
            
            // Fill the rest of the matrix
            for (let i = 1; i <= origWords.length; i++) {
                for (let j = 1; j <= genWords.length; j++) {
                    const cost = origWords[i-1] === genWords[j-1] ? 0 : 1;
                    dp[i][j] = Math.min(
                        dp[i-1][j] + 1,          // deletion
                        dp[i][j-1] + 1,          // insertion
                        dp[i-1][j-1] + cost      // substitution
                    );
                }
            }
            
            // Calculate WER
            const distance = dp[origWords.length][genWords.length];
            return origWords.length > 0 ? distance / origWords.length : 0;
        }
        
        // Function to create the WER distribution chart
        function createWERDistChart(werValues) {
            const ctx = document.getElementById('werDistChart').getContext('2d');
            
            // Hide loading indicator
            document.getElementById('loading-wer-dist').style.display = 'none';
            
            // Create histogram bins (0 to 1 in steps of 0.05)
            const bins = Array.from({length: 21}, (_, i) => i * 0.05);
            
            // Count values in each bin
            const counts = Array(bins.length).fill(0);
            werValues.forEach(wer => {
                const binIndex = Math.min(Math.floor(wer / 0.05), bins.length - 1);
                counts[binIndex]++;
            });
            
            // Create labels for the chart
            const labels = bins.map((bin, i) => {
                if (i === bins.length - 1) return `${bin.toFixed(2)}+`;
                return `${bin.toFixed(2)}-${(bin + 0.05).toFixed(2)}`;
            });
            
            // Create bar chart
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Word Error Rate',
                        data: counts,
                        backgroundColor: 'rgba(233, 84, 32, 0.5)',
                        borderColor: 'rgba(233, 84, 32, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Word Error Rate (WER)',
                                color: '#E95420',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#FFF'
                            },
                            grid: {
                                color: 'rgba(119, 41, 83, 0.3)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Conversations',
                                color: '#E95420',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#FFF'
                            },
                            grid: {
                                color: 'rgba(119, 41, 83, 0.3)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#FFF'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Count: ${context.raw}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Function to calculate WER statistics for all conversations
        function calculateWERStats(conversations) {
            const werValues = [];
            
            conversations.forEach(conv => {
                // Skip if no messages
                if (!conv.orig_messages || !conv.synthetic_messages || 
                    conv.orig_messages.length === 0 || conv.synthetic_messages.length === 0) {
                    return;
                }
                
                // Calculate WER for each pair of messages
                const minLength = Math.min(conv.orig_messages.length, conv.synthetic_messages.length);
                for (let i = 0; i < minLength; i++) {
                    const origText = conv.orig_messages[i].text || '';
                    const synthText = conv.synthetic_messages[i].text || '';
                    const wer = calculateWER(origText, synthText);
                    werValues.push(wer);
                }
            });
            
            // Calculate statistics
            const avg = werValues.reduce((sum, val) => sum + val, 0) / werValues.length;
            const sorted = [...werValues].sort((a, b) => a - b);
            const median = sorted.length % 2 === 0 
                ? (sorted[sorted.length/2 - 1] + sorted[sorted.length/2]) / 2
                : sorted[Math.floor(sorted.length/2)];
            const min = Math.min(...werValues);
            const max = Math.max(...werValues);
            
            // Calculate standard deviation
            const variance = werValues.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / werValues.length;
            const std = Math.sqrt(variance);
            
            return {
                values: werValues,
                avg,
                median,
                min,
                max,
                std
            };
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            fetchDatasetStats();
            loadPromptFile();
            loadConfigFile();
        });
    </script>
</body>
</html> 